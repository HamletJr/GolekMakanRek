{% extends "base.html" %}
{% load static %}

{% block meta %}
  <title>GolekMakanRek!</title>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}
  <h1 class="text-3xl font-bold text-center mt-8">Selamat datang!</h1>
  <p class="text-center mt-2">Apa yang ingin kamu cari?</p>
  <div class="flex justify-center mt-4 mb-8">
    <button id="foodToggle" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mx-2">Makanan</button>
    <button id="restoToggle" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded mx-2">Restoran</button>
  </div>
  <div id="container" class="max-w-4xl mx-auto p-4 bg-white shadow-md rounded-lg">
    <div class="mb-4">
      <form id="searchFoodForm" class="flex flex-col space-y-4">
        {{ food_search }}
        <label class="inline-flex items-center mt-2">
          <input type="checkbox" name="like_filter" class="form-checkbox h-5 w-5 text-blue-600">
          <span class="ml-2 text-gray-700">Tampilkan makanan yang disukai saja</span>
        </label>
        <input type="submit" value="Cari" class="mt-4 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
      </form>
    </div>
    <div id="food_cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
  </div>
  <script>
      // check auth for likes + check view buttons
      async function getFood() {
          return fetch("{% url 'homepage:get_food' %}").then(
              (res) => res.json()
          )
      }
      async function getRestaurants() {
          return fetch("{% url 'homepage:get_restaurant' %}").then(
              (res) => res.json()
          )
      }
      async function getLikes() {
          return fetch("{% url 'homepage:get_likes' %}").then(
              (res) => {
                  if (res.ok) {
                      return res.json()
                  }
                  else {
                      return null;
                  }
              }
          )
      }
      function toggleFood() {
          document.getElementById("container").innerHTML = `
            <div style="margin-bottom: 10px;">
              <form id="searchFoodForm" class="flex flex-col space-y-4">
                {{ food_search }}
                <label class="inline-flex items-center mt-2">
                  <input type="checkbox" name="like_filter" class="form-checkbox h-5 w-5 text-blue-600">
                  <span class="ml-2 text-gray-700">Tampilkan makanan yang disukai saja</span>
                </label>
                <input type="submit" value="Cari" class="mt-4 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
              </form>
            </div>
            <div id="food_cards"></div>
        `;
        document.querySelector("#searchFoodForm").addEventListener("submit", (e) => {
            e.preventDefault();
            refreshFood(true);
        });
        refreshFood();
      }
      function toggleRestaurant() {
          document.getElementById("container").innerHTML = `
            <div style="margin-bottom: 10px;">
              <form id="searchRestaurantForm" class="flex flex-col space-y-4">
                {{ restaurant_search }}
                <input type="submit" value="Cari" class="mt-4 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
              </form>
            </div>
            <div id="restaurant_cards"></div>
          `;
          document.querySelector("#searchRestaurantForm").addEventListener("submit", (e) => {
              e.preventDefault();
              refreshRestaurants(true);
          });
          refreshRestaurants();
      }
      async function refreshFood(search=false) {
          document.getElementById("food_cards").innerHTML = "";
          document.getElementById("food_cards").className = "";
          let food;
          if (search) {
              food = await searchFood();              
          }
          else {
              food = await getFood();
          }
          {% if user.is_authenticated %}
          const likes = await getLikes();
          {% else %}
          const likes = null;
          {% endif %}
          let htmlString = "";
          let classNameString = "";
      
          if (food.length === 0) {
              classNameString = "container";
              htmlString = `
                  <img src="{% static 'image/sad_image.png' %}" alt="Crying girl" class="img-fluid" width="100" height="100" />
                  <h3 class="title mt-3">Belum ada makanan terdaftar!</h3>
              `;
          }
          else {
              if (likes == null) {
                  classNameString = "container";
                  htmlString = "";
                  food.forEach((item) => {
                      const name = DOMPurify.sanitize(item.fields.nama);
                      const description = DOMPurify.sanitize(item.fields.deskripsi);
                      htmlString += `
                      <div class="bg-gray-100 p-4 rounded-lg shadow-md mb-4 border-2 border-gray-300">
                          <h2 class="text-xl font-semibold">${name}</h2>
                          <p class="text-gray-700">${description}</p>
                          <p class="text-green-600 font-bold">Rp ${item.fields.harga}</p>
                          <form class="like_form" id="${item.pk}">
                              <input type="hidden" id="id_food_id" name="food_id" value="${item.pk}">
                              <button type="submit" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Like!</button>
                          </form>
                          <a href=""><button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mt-2">View</button></a>
                      </div>
                  `;
                  });
                  htmlString += "</div>";
              }
              else {
                  classNameString = "container";
                  htmlString = "";
                  food.forEach((item) => {
                      const isLiked = likes.some((like) => like.fields.food_id === item.pk);
                      const name = DOMPurify.sanitize(item.fields.nama);
                      const description = DOMPurify.sanitize(item.fields.deskripsi);
                      htmlString += `
                        <div class="bg-gray-100 p-4 rounded-lg shadow-md mb-4 border-2 border-gray-300">
                          <h2 class="text-xl font-semibold">${name}</h2>
                          <p class="text-gray-700">${description}</p>
                          <p class="text-green-600 font-bold">Rp ${item.fields.harga}</p>
                          <form class="like_form" id="${item.pk}">
                              <input type="hidden" id="id_user_id" name="user_id" value="{{ user.pk }}">
                              <input type="hidden" id="id_food_id" name="food_id" value="${item.pk}">
                              <button type="submit" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">${isLiked ? "Remove Like!" : "Like!"}</button>
                          </form>
                          <a href=""><button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mt-2">View</button></a>
                      </div>
                  `;
                  });
                  htmlString += "</div>";
              }
          }
          
          document.getElementById("food_cards").className = classNameString;
          document.getElementById("food_cards").innerHTML = htmlString;
          document.querySelectorAll(".like_form").forEach((form) => {
              form.addEventListener("submit", (e) => {
                  e.preventDefault();
                  toggleLike(form.id);
              });
          });
      }
      async function refreshRestaurants(search=false) {
          document.getElementById("restaurant_cards").innerHTML = "";
          document.getElementById("restaurant_cards").className = "";
          let restaurant;
          if (search) {
              restaurant = await searchRestaurant();
          }
          else {
              restaurant = await getRestaurants();
          }
          let htmlString = "";
          let classNameString = "";
      
          if (restaurant.length === 0) {
              classNameString = "container";
              htmlString = `
                  <img src="{% static 'image/sad_image.png' %}" alt="Crying girl" class="img-fluid" width="100" height="100" />
                  <h3 class="title mt-3">Belum ada makanan terdaftar!</h3>
              `;
          }
          else {
              classNameString = "container";
              htmlString = "";
              restaurant.forEach((resto) => {
                  const name = DOMPurify.sanitize(resto.fields.nama);
                  const description = DOMPurify.sanitize(resto.fields.deskripsi);
                  htmlString += `
                    <div class="bg-gray-100 p-4 rounded-lg shadow-md mb-4 border-2 border-gray-300">
                      <h2 class="text-xl font-semibold">${name}</h2>
                      <p class="text-gray-700">${description}</p>
                      <a href=""><button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mt-2">View</button></a>
                    </div>
              `;
              });
              htmlString += "</div>";
          }
          
          document.getElementById("restaurant_cards").className = classNameString;
          document.getElementById("restaurant_cards").innerHTML = htmlString;
      }
      async function searchFood() {
          const params = new URLSearchParams(new FormData(document.getElementById("searchFoodForm"))).toString();
          return fetch("{% url 'homepage:get_food' %}?" + params).then(
              response => response.json()
          );
      }
      async function searchRestaurant() {
          const params = new URLSearchParams(new FormData(document.getElementById("searchRestaurantForm"))).toString();
          return fetch("{% url 'homepage:get_restaurant' %}?" + params).then(
              response => response.json()
          );
      }
      function toggleLike(formId) {
          fetch("{% url 'homepage:toggle_like' %}", {
              method: "POST",
              body: new FormData(document.getElementById(formId)),
          })
          .then(response => { 
              if (response.ok) {
                  document.getElementById(formId).querySelector("button").textContent = document.getElementById(formId).querySelector("button").textContent === "Like!" ? "Remove Like!" : "Like!";
              }
              else if (response.redirected){
                  window.location.href = response.url;
              }
              else {
                  alert("Failed to save changes! Try again later.");
              }
          });
          return false;
      }
      document.querySelectorAll(".like_form").forEach((form) => {
          form.addEventListener("submit", (e) => {
              e.preventDefault();
              toggleLike(form.id);
          });
      });
      document.querySelector("#searchFoodForm").addEventListener("submit", (e) => {
          e.preventDefault();
          refreshFood(true);
      });
      document.querySelector("#foodToggle").addEventListener("click", toggleFood);
      document.querySelector("#restoToggle").addEventListener("click", toggleRestaurant);
      refreshFood();
  </script>
{% endblock %}